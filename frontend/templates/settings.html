<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="alternate icon" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    <script>
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è
        (function() {
            try {
                const savedTheme = localStorage.getItem('panel-theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ç–µ–º–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                if (savedTheme === 'custom') {
                    const customThemesStr = localStorage.getItem('panel-custom-themes');
                    if (customThemesStr) {
                        try {
                            const customThemes = JSON.parse(customThemesStr);
                            const customThemeName = localStorage.getItem('panel-custom-theme-name') || 'custom';
                            const customTheme = customThemes[customThemeName];
                            if (customTheme) {
                                const root = document.documentElement;
                                Object.keys(customTheme).forEach(key => {
                                    if (key.startsWith('--')) {
                                        root.style.setProperty(key, customTheme[key]);
                                    }
                                });
                            }
                        } catch(e) {
                            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ç–µ–º—ã:', e);
                        }
                    }
                }
            } catch(e) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–Ω–µ–ª–∏
            </span>
            <button class="btn btn-outline-light" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="alerts-container"></div>
        
        <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-lock"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h5>
            </div>
            <div class="card-body">
                <form id="change-password-form">
                    <div class="mb-3">
                        <label for="current-password" class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="current-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="new-password" required minlength="3">
                        <small class="form-text text-muted">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm-password" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="confirm-password" required minlength="3">
                    </div>
                    <button type="submit" class="btn btn-primary" id="change-password-btn">
                        <i class="fas fa-key"></i> –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                </form>
            </div>
        </div>
        
        <!-- SSH –∫–ª—é—á –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-key"></i> SSH –∫–ª—é—á –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ –∏ –∑–∞—á–µ–º –Ω—É–∂–Ω–æ?</h6>
                    <p class="mb-2">
                        SSH –∫–ª—é—á –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ <strong>–ø—Ä–∏–≤–∞—Ç–Ω—ã–º Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º</strong> (GitHub, GitLab, Bitbucket). 
                        –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–µ–∑ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è.
                    </p>
                    <p class="mb-0">
                        <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SSH –∫–ª—é—á. –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ –≤–∞—à Git –∞–∫–∫–∞—É–Ω—Ç, 
                        –ø–∞–Ω–µ–ª—å —Å–º–æ–∂–µ—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –±–æ—Ç–æ–≤. 
                        –û–¥–∏–Ω –∫–ª—é—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –≤ –ø–∞–Ω–µ–ª–∏.
                    </p>
                </div>
                
                <div id="ssh-key-container">
                    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                
                <div id="ssh-key-info-container" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="mb-3"><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ</h6>
                            <div id="ssh-key-details"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="loadSSHKey()" id="reload-ssh-key-btn">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-secondary" onclick="generateNewSSHKey()" id="generate-ssh-key-btn">
                        <i class="fas fa-key"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á
                    </button>
                    <button class="btn btn-info" onclick="testSSHConnection()" id="test-ssh-connection-btn">
                        <i class="fas fa-plug"></i> –¢–µ—Å—Ç SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-palette"></i> –í—ã–±–æ—Ä —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
                    <div id="themes-grid" class="row g-3">
                        <!-- –¢–µ–º—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-plus-circle"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ç–µ–º–∞</h6>
                    <p class="text-muted small">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —Ç–µ–º—É, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–≤ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –∫–∞–∫ –æ—Å–Ω–æ–≤—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å –Ω—É–ª—è.</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-secondary btn-sm" onclick="exportCurrentTheme()">
                            <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
                        </button>
                        <button class="btn btn-info btn-sm" onclick="showImportThemeModal()">
                            <i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showEditThemeModal()">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å CSS
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏</h5>
            </div>
            <div class="card-body">
                <div id="panel-git-status">
                    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
                </div>
                <button class="btn btn-primary mt-2" onclick="updatePanel()" id="update-panel-btn">
                    <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ GitHub
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="confirmModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–º—ã -->
    <div class="modal fade" id="editThemeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="theme-name-input" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã:</label>
                        <input type="text" class="form-control" id="theme-name-input" placeholder="–ú–æ—è —Ç–µ–º–∞">
                    </div>
                    <div class="mb-3">
                        <label for="theme-css-editor" class="form-label">CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (JSON —Ñ–æ—Ä–º–∞—Ç):</label>
                        <textarea class="form-control font-monospace" id="theme-css-editor" rows="15" style="font-size: 0.85rem;"></textarea>
                        <small class="form-text text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: {"--variable-name": "value"}</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomTheme()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ —Ç–µ–º—ã -->
    <div class="modal fade" id="importThemeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-upload"></i> –ò–º–ø–æ—Ä—Ç —Ç–µ–º—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="import-theme-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã:</label>
                        <input type="text" class="form-control" id="import-theme-name" placeholder="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ–º–∞">
                    </div>
                    <div class="mb-3">
                        <label for="import-theme-json" class="form-label">JSON –¥–∞–Ω–Ω—ã–µ —Ç–µ–º—ã:</label>
                        <textarea class="form-control font-monospace" id="import-theme-json" rows="10" style="font-size: 0.85rem;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="importTheme()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/theme-manager.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            loadThemes();
            loadPanelGitStatus();
            loadSSHKey();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
            const changePasswordForm = document.getElementById('change-password-form');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }
        });
        
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'danger');
                return;
            }
            
            if (newPassword.length < 3) {
                showAlert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'danger');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'danger');
                return;
            }
            
            if (currentPassword === newPassword) {
                showAlert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ', 'danger');
                return;
            }
            
            const btn = document.getElementById('change-password-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ...';
            
            try {
                const response = await fetch('/api/panel/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('change-password-form').reset();
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-key"></i> –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
            }
        }
        
        async function loadSSHKey() {
            const container = document.getElementById('ssh-key-container');
            const infoContainer = document.getElementById('ssh-key-info-container');
            const detailsContainer = document.getElementById('ssh-key-details');
            
            container.innerHTML = '<p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ SSH –∫–ª—é—á–∞...</p>';
            if (infoContainer) infoContainer.style.display = 'none';
            
            try {
                const response = await fetch('/api/panel/ssh-key');
                const data = await response.json();
                
                if (data.success && data.public_key) {
                    container.innerHTML = `
                        <div class="mb-3">
                            <label class="form-label"><strong>–ü—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á:</strong></label>
                            <div class="input-group">
                                <textarea class="form-control font-monospace" id="ssh-public-key" rows="4" readonly style="font-size: 0.85rem; background: var(--bg-secondary); color: var(--text-primary);">${escapeHtml(data.public_key)}</textarea>
                                <button class="btn btn-outline-secondary" onclick="copySSHKey()" type="button" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ
                    if (infoContainer && detailsContainer) {
                        let infoHtml = '<div class="row">';
                        if (data.key_type) {
                            infoHtml += `<div class="col-md-6 mb-2"><strong>–¢–∏–ø –∫–ª—é—á–∞:</strong> <span class="badge bg-info">${escapeHtml(data.key_type)}</span></div>`;
                        }
                        if (data.key_size) {
                            infoHtml += `<div class="col-md-6 mb-2"><strong>–†–∞–∑–º–µ—Ä:</strong> ${escapeHtml(data.key_size)}</div>`;
                        }
                        if (data.ssh_available !== undefined) {
                            const sshStatus = data.ssh_available 
                                ? '<span class="badge bg-success"><i class="fas fa-check"></i> –î–æ—Å—Ç—É–ø–µ–Ω</span>'
                                : '<span class="badge bg-danger"><i class="fas fa-times"></i> –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>';
                            infoHtml += `<div class="col-md-6 mb-2"><strong>SSH –∫–ª–∏–µ–Ω—Ç:</strong> ${sshStatus}</div>`;
                        }
                        if (data.ssh_path) {
                            infoHtml += `<div class="col-md-6 mb-2"><strong>–ü—É—Ç—å –∫ SSH:</strong> <code>${escapeHtml(data.ssh_path)}</code></div>`;
                        }
                        infoHtml += '</div>';
                        detailsContainer.innerHTML = infoHtml;
                        infoContainer.style.display = 'block';
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    container.innerHTML += `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –∫–ª—é—á–∞ –≤ Git —Ö–æ—Å—Ç–∏–Ω–≥:</h6>
                            <div class="mb-2">
                                <strong>GitHub:</strong>
                                <ol class="mb-2">
                                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤—ã—à–µ</li>
                                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://github.com/settings/keys" target="_blank" class="alert-link">GitHub ‚Üí Settings ‚Üí SSH and GPG keys</a></li>
                                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"New SSH key"</strong></li>
                                    <li>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á</li>
                                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"Add SSH key"</strong></li>
                                </ol>
                            </div>
                            <div class="mb-2">
                                <strong>GitLab:</strong>
                                <ol class="mb-2">
                                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á</li>
                                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://gitlab.com/-/profile/keys" target="_blank" class="alert-link">GitLab ‚Üí Preferences ‚Üí SSH Keys</a></li>
                                    <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –∏ –Ω–∞–∂–º–∏—Ç–µ <strong>"Add key"</strong></li>
                                </ol>
                            </div>
                            <div>
                                <strong>Bitbucket:</strong>
                                <ol class="mb-0">
                                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á</li>
                                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://bitbucket.org/account/settings/ssh-keys/" target="_blank" class="alert-link">Bitbucket ‚Üí Personal settings ‚Üí SSH keys</a></li>
                                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"Add key"</strong> –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á</li>
                                </ol>
                            </div>
                        </div>
                        
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á".
                            ${data.error ? '<br><small class="text-danger">–û—à–∏–±–∫–∞: ' + escapeHtml(data.error) + '</small>' : ''}
                        </div>
                    `;
                    if (infoContainer) infoContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading SSH key:', error);
                container.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SSH –∫–ª—é—á–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).</div>';
                if (infoContainer) infoContainer.style.display = 'none';
            }
        }
        
        async function testSSHConnection() {
            const testBtn = document.getElementById('test-ssh-connection-btn');
            if (testBtn) testBtn.disabled = true;
            
            const hosts = ['github.com', 'gitlab.com', 'bitbucket.org'];
            const results = [];
            
            try {
                for (const host of hosts) {
                    try {
                        const response = await fetch('/api/panel/ssh-key/test', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ host: host })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ success –≤ –æ—Ç–≤–µ—Ç–µ
                            results.push({
                                host: host,
                                success: result.success === true,
                                message: result.message || (result.success ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è')
                            });
                        } else {
                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ 200, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—à–∏–±–∫—É
                            const error = await response.json().catch(() => ({ detail: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è' }));
                            results.push({
                                host: host,
                                success: false,
                                message: error.detail || error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'
                            });
                        }
                    } catch (error) {
                        results.push({
                            host: host,
                            success: false,
                            message: error.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'
                        });
                    }
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                let successCount = results.filter(r => r.success).length;
                let message = `–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: ${results.length}\n–£—Å–ø–µ—à–Ω—ã—Ö: ${successCount}\n\n`;
                
                results.forEach(result => {
                    const icon = result.success ? '‚úÖ' : '‚ùå';
                    message += `${icon} ${result.host}: ${result.message}\n`;
                });
                
                if (successCount === results.length) {
                    showAlert('SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', '–í—Å–µ —Ç–µ—Å—Ç—ã SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else if (successCount > 0) {
                    showAlert('–ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö', message, 'warning');
                } else {
                    showAlert('–û—à–∏–±–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', message, 'danger');
                }
            } catch (error) {
                console.error('Error testing SSH connection:', error);
                showAlert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SSH', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –°–º. –∫–æ–Ω—Å–æ–ª—å (F12).', 'danger');
            } finally {
                if (testBtn) testBtn.disabled = false;
            }
        }
        
        async function generateNewSSHKey() {
            const confirmed = await showConfirm(
                '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ SSH –∫–ª—é—á–∞',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π SSH –∫–ª—é—á? –°—Ç–∞—Ä—ã–π –∫–ª—é—á –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω, –∏ –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ –≤–æ –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö GitHub.',
                'btn-warning'
            );
            if (!confirmed) {
                return;
            }
            
            const btn = document.getElementById('generate-ssh-key-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            
            try {
                console.log('=== SSH KEY GENERATION REQUEST ===');
                const response = await fetch('/api/panel/ssh-key/generate', {
                    method: 'POST'
                });
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (data.success === true) {
                        showAlert('SSH –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –∏–∑ –æ—Ç–≤–µ—Ç–∞ API –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        if (data.public_key) {
                            updateSSHKeyDisplay(data.public_key);
                        } else {
                            // –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –≤ –æ—Ç–≤–µ—Ç–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                            setTimeout(() => {
                                loadSSHKey();
                            }, 500);
                        }
                    } else {
                        console.error('SSH key generation failed:', data);
                        console.group('%c‚ùå –û–®–ò–ë–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–ò SSH –ö–õ–Æ–ß–ê', 'color: red; font-weight: bold; font-size: 14px;');
                        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', data.message);
                        if (data.error_type) console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', data.error_type);
                        if (data.traceback) {
                            console.group('üìã Traceback:');
                            console.error(data.traceback);
                            console.groupEnd();
                        }
                        console.groupEnd();
                        showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞: ' + (data.message || 'Unknown error'), 'danger');
                    }
                } else {
                    console.error('Response not OK:', response.status, response.statusText);
                    const text = await response.text();
                    console.error('Response text:', text);
                    
                    let error;
                    try {
                        error = JSON.parse(text);
                    } catch {
                        error = { detail: text || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
                    }
                    
                    console.group('%c‚ùå HTTP –û–®–ò–ë–ö–ê', 'color: red; font-weight: bold; font-size: 14px;');
                    console.error('–°—Ç–∞—Ç—É—Å:', response.status);
                    console.error('–î–µ—Ç–∞–ª–∏:', error);
                    console.groupEnd();
                    
                    showAlert('–û—à–∏–±–∫–∞: ' + (error.detail || error.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.group('%c‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê', 'color: red; font-weight: bold; font-size: 14px;');
                console.error('–û—à–∏–±–∫–∞:', error);
                console.error('Stack:', error.stack);
                console.groupEnd();
                showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SSH –∫–ª—é—á–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-key"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á';
            }
        }
        
        function updateSSHKeyDisplay(publicKey) {
            const container = document.getElementById('ssh-key-container');
            if (!container || !publicKey) return;
            
            container.innerHTML = `
                <div class="mb-3">
                    <label class="form-label"><strong>–ü—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á:</strong></label>
                    <div class="input-group">
                        <textarea class="form-control font-monospace" id="ssh-public-key" rows="4" readonly style="font-size: 0.85rem; background: var(--bg-secondary); color: var(--text-primary);">${escapeHtml(publicKey)}</textarea>
                        <button class="btn btn-outline-secondary" onclick="copySSHKey()" type="button" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –∫–ª—é—á–∞ –≤ GitHub:</h6>
                    <ol class="mb-0">
                        <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤—ã—à–µ (–∫–Ω–æ–ø–∫–∞ "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å")</li>
                        <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://github.com/settings/keys" target="_blank" class="alert-link">GitHub ‚Üí Settings ‚Üí SSH and GPG keys</a></li>
                        <li>–ù–∞–∂–º–∏—Ç–µ <strong>"New SSH key"</strong></li>
                        <li>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Bot Panel Deploy Key")</li>
                        <li>–í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –≤ –ø–æ–ª–µ <strong>"Key"</strong></li>
                        <li>–ù–∞–∂–º–∏—Ç–µ <strong>"Add SSH key"</strong></li>
                    </ol>
                </div>
                
            `;
        }
        
        function copySSHKey() {
            const textarea = document.getElementById('ssh-public-key');
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                showAlert('SSH –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }
        }

        async function loadPanelGitStatus() {
            try {
                console.log('Loading panel git status...');
                const response = await fetch('/api/panel/git-status');
                const status = await response.json();
                console.log('Git status response:', status);
                
                const container = document.getElementById('panel-git-status');
                if (status.is_repo) {
                    container.innerHTML = `
                        <p><strong>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</strong> ${escapeHtml(status.remote || '–ù–µ —É–∫–∞–∑–∞–Ω')}</p>
                        ${status.last_commit && status.last_commit.message ? `
                            <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:</strong> ${escapeHtml(status.last_commit.message)}</p>
                            ${status.last_commit.date ? `<p class="text-muted small mb-2">${escapeHtml(status.last_commit.date)}</p>` : ''}
                        ` : '<p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:</strong> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>'}
                        ${status.has_updates ? `
                            <div class="alert alert-info mt-2">
                                <i class="fas fa-arrow-down"></i> <strong>–î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!</strong> –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ GitHub" –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
                            </div>
                        ` : ''}
                    `;
                    document.getElementById('update-panel-btn').disabled = false;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Git
                    if (status.git_not_installed) {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-circle"></i> Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</h6>
                                <p class="mb-2">${escapeHtml(status.error || 'Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ')}</p>
                                <p class="mb-2"><strong>–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Git:</strong></p>
                                <ul class="mb-2">
                                    <li><strong>Windows:</strong> –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <a href="https://git-scm.com/download/win" target="_blank" class="alert-link">Git for Windows</a></li>
                                    <li><strong>Linux:</strong> <code>sudo apt-get install git</code> (Ubuntu/Debian) –∏–ª–∏ <code>sudo yum install git</code> (CentOS/RHEL)</li>
                                    <li><strong>macOS:</strong> <code>brew install git</code> –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Xcode Command Line Tools</li>
                                </ul>
                                <p class="mb-0">–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Git –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∞–Ω–µ–ª—å.</p>
                            </div>
                        `;
                        document.getElementById('update-panel-btn').disabled = true;
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞
                        const errorMsg = status.error ? `<p class="text-danger mb-2"><strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(status.error)}</p>` : '';
                        
                        container.innerHTML = `
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> –ü–∞–Ω–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º</h6>
                                ${errorMsg}
                                <p class="mb-2">–ü–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é <strong>https://github.com/Focusniks/DSTG_Panel</strong>.</p>
                                <button class="btn btn-primary btn-sm" onclick="initPanelGitRepo()">
                                    <i class="fas fa-code-branch"></i> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
                                </button>
                            </div>
                        `;
                        document.getElementById('update-panel-btn').disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error loading panel git status:', error);
                document.getElementById('panel-git-status').innerHTML = 
                    '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞</p>';
            }
        }

        async function initPanelGitRepo() {
            console.log('initPanelGitRepo called');
            
            const btn = document.querySelector('button[onclick="initPanelGitRepo()"]');
            const originalBtnText = btn ? btn.innerHTML : '';
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
            }
            
            try {
                console.log('Sending request to /api/panel/init-git');
                // URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤ –∑–∞–ø—Ä–æ—Å–µ
                const response = await fetch('/api/panel/init-git', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                let result;
                try {
                    result = await response.json();
                    console.log('Response result (full):', JSON.stringify(result, null, 2));
                    console.log('Result success:', result.success);
                    console.log('Result success type:', typeof result.success);
                    console.log('Result message:', result.message);
                    console.log('Result keys:', Object.keys(result));
                } catch (e) {
                    console.error('Failed to parse JSON response:', e);
                    const text = await response.text();
                    console.error('Response text:', text);
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const isSuccess = response.ok && (
                    result.success === true || 
                    result.success === 'true' ||
                    (result.message && result.message.toLowerCase().includes('success')) ||
                    (result.message && result.message.toLowerCase().includes('–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'))
                );
                
                console.log('isSuccess:', isSuccess);
                
                if (isSuccess) {
                    console.log('Success branch - showing alert');
                    const successMsg = result.message || 'Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!';
                    showAlert(successMsg, 'success');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    setTimeout(() => {
                        loadPanelGitStatus();
                    }, 1500);
                } else {
                    console.log('Not in success branch');
                    console.log('response.ok:', response.ok);
                    console.log('result.success:', result.success);
                    console.log('result:', result);
                    const errorMsg = result.detail || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    console.error('Git init error:', errorMsg);
                    showAlert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + errorMsg, 'danger');
                    
                    // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å –≤–∏–¥–∏–º–æ–π
                }
            } catch (error) {
                console.error('Error initializing Git repo:', error);
                const errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                showAlert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ' + errorMsg, 'danger');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            }
        }

        async function updatePanel() {
            console.log('[updatePanel] –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏');
            
            const confirmed = await showConfirm(
                '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏',
                '–û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ GitHub? –ü–∞–Ω–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.',
                'btn-primary'
            );
            
            console.log('[updatePanel] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', confirmed);
            if (!confirmed) {
                console.log('[updatePanel] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                return;
            }
            
            const btn = document.getElementById('update-panel-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            
            console.log('[updatePanel] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/panel/update');
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/panel/update', {
                    method: 'POST'
                });
                
                const responseTime = Date.now() - startTime;
                console.log('[updatePanel] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    responseTime: responseTime + 'ms',
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                let result;
                try {
                    result = await response.json();
                    console.log('[updatePanel] –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', result);
                } catch (jsonError) {
                    console.error('[updatePanel] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', jsonError);
                    const text = await response.text();
                    console.error('[updatePanel] –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', text);
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + text);
                }
                
                if (result.success) {
                    console.log('[updatePanel] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    console.log('[updatePanel] –°–æ–æ–±—â–µ–Ω–∏–µ:', result.message);
                    showAlert('–ü–∞–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'success');
                    setTimeout(() => {
                        console.log('[updatePanel] –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
                        window.location.reload();
                    }, 2000);
                } else {
                    console.error('[updatePanel] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π');
                    console.error('[updatePanel] –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:', result.message);
                    console.error('[updatePanel] –ü–æ–ª–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                    showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (result.message || 'Unknown error'), 'danger');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ GitHub';
                }
            } catch (error) {
                console.error('[updatePanel] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞–Ω–µ–ª–∏:', error);
                console.error('[updatePanel] –¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
                console.error('[updatePanel] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏:', error.message);
                console.error('[updatePanel] –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error.stack);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    console.error('[updatePanel] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ - –≤–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ GitHub';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirm(title, message, confirmBtnClass = 'btn-danger') {
            return new Promise((resolve) => {
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                document.getElementById('confirmModalTitle').textContent = title;
                document.getElementById('confirmModalMessage').textContent = message;
                const confirmBtn = document.getElementById('confirmModalBtn');
                confirmBtn.className = 'btn ' + confirmBtnClass;
                
                const handleConfirm = () => {
                    modal.hide();
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(false);
                };
                
                confirmBtn.onclick = handleConfirm;
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', handleCancel, { once: true });
                
                modal.show();
            });
        }
        
        // –ü–æ–∫–∞–∑ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∫–∞–∫ –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º)
        function showToast(title, message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification ' + type;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle',
                danger: 'fa-exclamation-circle'
            };
            
            const icon = icons[type] || icons.info;
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    ${message ? '<div class="toast-message">' + escapeHtml(message) + '</div>' : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.classList.add('hiding');
                    setTimeout(function() {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function showAlert(param1, param2, param3 = undefined) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∏–ø –¥–ª—è toast
            let title, message, type;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞
            if (param3 !== undefined) {
                // –§–æ—Ä–º–∞—Ç: showAlert(title, message, type)
                title = param1;
                message = param2;
                type = param3;
            } else {
                // –§–æ—Ä–º–∞—Ç: showAlert(message, type)
                title = param1;
                message = '';
                type = param2;
            }
            
            const toastType = type === 'danger' ? 'error' : type;
            showToast(title, message, toastType);
        }
        
        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function showAlertOld(message, type) {
            const container = document.getElementById('alerts-container');
            if (!container) {
                const newContainer = document.createElement('div');
                newContainer.id = 'alerts-container';
                newContainer.className = 'position-fixed top-0 end-0 p-3';
                newContainer.style.zIndex = '9999';
                document.body.appendChild(newContainer);
                container = newContainer;
            }
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type + ' alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = escapeHtml(message) + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            
            container.appendChild(alert);
            
            setTimeout(function() {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–∞–º–∏
        function loadThemes() {
            if (!window.themeManager) {
                console.error('ThemeManager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            const themesGrid = document.getElementById('themes-grid');
            if (!themesGrid) return;

            const themes = window.themeManager.getAvailableThemes();
            const currentTheme = window.themeManager.currentTheme;
            const currentCustomName = localStorage.getItem('panel-custom-theme-name');

            themesGrid.innerHTML = '';

            themes.forEach(theme => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6';

                const isActive = (theme.id === currentTheme && 
                    (theme.id !== 'custom' || theme.customName === currentCustomName));

                col.innerHTML = `
                    <div class="card theme-card ${isActive ? 'border-primary' : ''}" 
                         style="cursor: pointer; ${isActive ? 'border-width: 2px;' : ''}"
                         onclick="selectTheme('${theme.id}', '${theme.customName || ''}')">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${theme.icon}</div>
                            <h6 class="card-title">${theme.name}</h6>
                            ${isActive ? '<span class="badge bg-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>' : ''}
                            ${theme.id === 'custom' && theme.customName ? 
                                `<button class="btn btn-sm btn-danger mt-2" onclick="event.stopPropagation(); deleteCustomTheme('${theme.customName}')">
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>` : ''}
                        </div>
                    </div>
                `;

                themesGrid.appendChild(col);
            });
        }

        function selectTheme(themeId, customName) {
            if (!window.themeManager) return;

            if (themeId === 'custom' && customName) {
                localStorage.setItem('panel-custom-theme-name', customName);
            }

            window.themeManager.setTheme(themeId);
            loadThemes();
            showAlert('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
        }

        function exportCurrentTheme() {
            if (!window.themeManager) return;

            const theme = window.themeManager.exportTheme(window.themeManager.currentTheme);
            if (!theme) {
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É', 'danger');
                return;
            }

            const json = JSON.stringify(theme, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `theme-${window.themeManager.currentTheme}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showAlert('–¢–µ–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        }

        function showImportThemeModal() {
            const modal = new bootstrap.Modal(document.getElementById('importThemeModal'));
            document.getElementById('import-theme-name').value = '';
            document.getElementById('import-theme-json').value = '';
            modal.show();
        }

        function importTheme() {
            if (!window.themeManager) return;

            const name = document.getElementById('import-theme-name').value.trim();
            const jsonText = document.getElementById('import-theme-json').value.trim();

            if (!name) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã', 'warning');
                return;
            }

            if (!jsonText) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ JSON –¥–∞–Ω–Ω—ã–µ —Ç–µ–º—ã', 'warning');
                return;
            }

            try {
                const themeData = JSON.parse(jsonText);
                window.themeManager.importTheme(name, themeData);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('importThemeModal'));
                modal.hide();
                
                loadThemes();
                showAlert('–¢–µ–º–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' + e.message, 'danger');
            }
        }

        function showEditThemeModal() {
            if (!window.themeManager) return;

            const currentTheme = window.themeManager.currentTheme;
            const theme = window.themeManager.exportTheme(currentTheme);
            
            if (!theme) {
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('editThemeModal'));
            document.getElementById('theme-name-input').value = 
                currentTheme === 'custom' ? (localStorage.getItem('panel-custom-theme-name') || '–ú–æ—è —Ç–µ–º–∞') : '–ú–æ—è —Ç–µ–º–∞';
            document.getElementById('theme-css-editor').value = JSON.stringify(theme, null, 2);
            modal.show();
        }

        function saveCustomTheme() {
            if (!window.themeManager) return;

            const name = document.getElementById('theme-name-input').value.trim();
            const jsonText = document.getElementById('theme-css-editor').value.trim();

            if (!name) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã', 'warning');
                return;
            }

            if (!jsonText) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ', 'warning');
                return;
            }

            try {
                const themeData = JSON.parse(jsonText);
                window.themeManager.saveCustomTheme(name, themeData);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editThemeModal'));
                modal.hide();
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
                localStorage.setItem('panel-custom-theme-name', name);
                window.themeManager.setTheme('custom');
                
                loadThemes();
                showAlert('–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' + e.message, 'danger');
            }
        }

        function deleteCustomTheme(themeName) {
            if (!window.themeManager) return;

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É "${themeName}"?`)) return;

            window.themeManager.deleteCustomTheme(themeName);
            loadThemes();
            showAlert('–¢–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        }
    </script>
</body>
</html>

