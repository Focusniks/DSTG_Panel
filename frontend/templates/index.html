<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления ботами - DSTG Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-robot"></i> 
                <span class="d-none d-md-inline">DSTG Panel</span>
            </span>
            <button class="mobile-menu-toggle d-lg-none" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="navbar-nav ms-auto d-flex flex-row gap-2">
                <button class="btn btn-outline-light" onclick="window.location.href='/settings'" title="Настройки">
                    <i class="fas fa-cog"></i>
                    <span class="d-none d-md-inline ms-1">Настройки</span>
                </button>
                <button class="btn btn-outline-danger" onclick="logout()" title="Выход">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="d-none d-md-inline ms-1">Выход</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="alerts-container"></div>
        
        <!-- Header Section -->
        <div class="dashboard-header mb-5">
            <div class="dashboard-header-content">
                <div class="dashboard-title-section">
                    <h1 class="dashboard-title">
                        <span class="title-icon">
                            <i class="fas fa-robot"></i>
                        </span>
                        <span class="title-text">Панель управления ботами</span>
                    </h1>
                    <p class="dashboard-subtitle">Управляйте ботами для Discord и Telegram: запуск, мониторинг, редактирование кода, работа с Git репозиториями</p>
                </div>
                <button class="btn-create-bot" data-bs-toggle="modal" data-bs-target="#createBotModal">
                    <i class="fas fa-plus"></i>
                    <span>Создать бота</span>
                </button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid mb-5" id="stats-overview" style="display: none;">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Всего ботов</div>
                    <div class="stat-card-value" id="total-bots">0</div>
                </div>
            </div>
            <div class="stat-card stat-card-success">
                <div class="stat-card-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Запущено</div>
                    <div class="stat-card-value" id="running-bots">0</div>
                </div>
            </div>
            <div class="stat-card stat-card-warning">
                <div class="stat-card-icon">
                    <i class="fas fa-stop-circle"></i>
                </div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Остановлено</div>
                    <div class="stat-card-value" id="stopped-bots">0</div>
                </div>
            </div>
            <div class="stat-card stat-card-danger">
                <div class="stat-card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Ошибки</div>
                    <div class="stat-card-value" id="error-bots">0</div>
                </div>
            </div>
        </div>

        <!-- Bots List -->
        <div id="bots-list">
            <div class="loading-state">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <p class="loading-text">Загрузка ботов...</p>
            </div>
        </div>
    </div>

    <!-- Modal создания бота -->
    <div class="modal fade" id="createBotModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle text-neon-cyan"></i> Создать нового бота
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-bot-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-bot-name" class="form-label">
                                        <i class="fas fa-tag"></i> Название бота
                                    </label>
                                    <input type="text" class="form-control" id="create-bot-name" required placeholder="Мой бот">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-bot-type" class="form-label">
                                        <i class="fas fa-code-branch"></i> Тип бота
                                    </label>
                                    <select class="form-select" id="create-bot-type" required>
                                        <option value="discord">Discord</option>
                                        <option value="telegram">Telegram</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="create-start-file" class="form-label">
                                <i class="fas fa-file-code"></i> Стартовый файл
                            </label>
                            <input type="text" class="form-control" id="create-start-file" placeholder="main.py">
                            <small class="form-text text-muted">Файл, который будет запускаться при старте бота</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-cpu-limit" class="form-label">
                                        <i class="fas fa-microchip"></i> Лимит CPU (%)
                                    </label>
                                    <input type="number" class="form-control" id="create-cpu-limit" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-memory-limit" class="form-label">
                                        <i class="fas fa-memory"></i> Лимит памяти (MB)
                                    </label>
                                    <input type="number" class="form-control" id="create-memory-limit" min="64" value="512">
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4" style="border-color: var(--border-color);">
                        
                        <h6 class="mb-3">
                            <i class="fab fa-github"></i> Git репозиторий <small class="text-muted">(опционально)</small>
                        </h6>
                        <div class="mb-3">
                            <label for="create-git-repo-url" class="form-label">URL репозитория</label>
                            <input type="text" class="form-control" id="create-git-repo-url" placeholder="https://github.com/user/repo.git или git@github.com:user/repo.git">
                            <small class="form-text text-muted">
                                Поддерживаются: GitHub, GitLab, Bitbucket и другие Git хостинги.<br>
                                Можно использовать HTTPS или SSH URL. Для приватных репозиториев система автоматически использует SSH (если настроен SSH ключ в настройках панели).
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="create-git-branch" class="form-label">Ветка</label>
                            <input type="text" class="form-control" id="create-git-branch" value="main" placeholder="main">
                            <small class="form-text text-muted">Ветка репозитория для клонирования (по умолчанию: main)</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Как это работает:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Если указать URL репозитория, он будет автоматически клонирован при создании бота</li>
                                <li>Если репозиторий не указан, будет создан бот из шаблона (базовый код для Discord/Telegram)</li>
                                <li>Файлы можно также загрузить вручную в разделе "Файлы" после создания бота</li>
                                <li>Для приватных репозиториев необходимо настроить SSH ключ в <a href="/settings" class="alert-link">настройках панели</a></li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="createBot()">
                        <i class="fas fa-plus"></i> Создать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для подтверждения действий -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Подтверждение</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">Вы уверены?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Создание бота
        async function createBot() {
            const name = document.getElementById('create-bot-name').value;
            const botType = document.getElementById('create-bot-type').value;
            const startFile = document.getElementById('create-start-file').value;
            const cpuLimit = parseFloat(document.getElementById('create-cpu-limit').value) || 50;
            const memoryLimit = parseInt(document.getElementById('create-memory-limit').value) || 512;
            const gitRepoUrl = document.getElementById('create-git-repo-url').value.trim() || null;
            const gitBranch = document.getElementById('create-git-branch').value.trim() || 'main';
            
            if (!name.trim()) {
                showAlert('Пожалуйста, введите название бота', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name.trim(),
                        bot_type: botType,
                        start_file: startFile.trim() || null,
                        cpu_limit: cpuLimit,
                        memory_limit: memoryLimit,
                        git_repo_url: gitRepoUrl,
                        git_branch: gitBranch
                    })
                });
                
                // Проверяем, является ли ответ JSON
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        console.error('JSON parse error:', jsonError);
                        const text = await response.text();
                        console.error('Response text:', text);
                        showAlert('Ошибка создания бота: Сервер вернул некорректный ответ. Проверьте консоль (F12).', 'danger');
                        return;
                    }
                } else {
                    // Если ответ не JSON, читаем как текст
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    showAlert('Ошибка создания бота: Сервер вернул ошибку. Проверьте консоль (F12).', 'danger');
                    return;
                }
                
                if (response.ok && result.id) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createBotModal'));
                    modal.hide();
                    document.getElementById('create-bot-form').reset();
                    
                    // Показываем предупреждение, если есть
                    if (result.warning) {
                        showAlert('Бот создан, но есть предупреждение: ' + result.warning, 'warning');
                        setTimeout(() => {
                            window.location.href = `/bot/${result.id}`;
                        }, 2000);
                    } else {
                        showAlert('Бот успешно создан!', 'success');
                        window.location.href = `/bot/${result.id}`;
                    }
                } else {
                    let errorMsg = result.detail || result.message || 'Неизвестная ошибка';
                    if (errorMsg.includes('already exists') || errorMsg.includes('уже существует')) {
                        errorMsg = 'Бот с таким именем уже существует. Выберите другое имя.';
                    }
                    showAlert('Ошибка создания бота: ' + errorMsg, 'danger');
                }
            } catch (error) {
                console.error('Error creating bot:', error);
                let errorMsg = 'Неизвестная ошибка';
                if (error.message) {
                    if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                        errorMsg = 'Не удалось подключиться к серверу. Проверьте соединение.';
                    } else if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
                        errorMsg = 'Ошибка обработки ответа сервера. Возможно, сервер вернул ошибку. Проверьте консоль (F12).';
                    } else {
                        errorMsg = error.message;
                    }
                }
                showAlert('Ошибка создания бота: ' + errorMsg, 'danger');
            }
        }
        
        // Выход
        function logout() {
            document.cookie = 'panel_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }
        
        // Mobile menu toggle
        document.getElementById('mobile-menu-toggle')?.addEventListener('click', function() {
            // Для мобильного меню можно добавить функционал позже
        });
    </script>
</body>
</html>
