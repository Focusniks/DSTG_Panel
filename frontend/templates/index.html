<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления ботами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-robot"></i> Панель управления ботами
            </span>
            <div>
                <button class="btn btn-outline-light me-2" onclick="window.location.href='/settings'">
                    <i class="fas fa-cog"></i> Настройки
                </button>
                <button class="btn btn-outline-light" onclick="window.location.href='/login'; document.cookie='panel_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'">
                    <i class="fas fa-sign-out-alt"></i> Выход
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="alerts-container"></div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-white">Боты</h1>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createBotModal">
                <i class="fas fa-plus"></i> Создать бота
            </button>
        </div>

        <div id="bots-list">
            <div class="text-center">
                <div class="spinner-border text-white" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal создания бота -->
    <div class="modal fade" id="createBotModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создать нового бота</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-bot-form">
                        <div class="mb-3">
                            <label for="create-bot-name" class="form-label">Название бота</label>
                            <input type="text" class="form-control" id="create-bot-name" required placeholder="Мой бот">
                        </div>
                        
                        <div class="mb-3">
                            <label for="create-bot-type" class="form-label">Тип бота</label>
                            <select class="form-select" id="create-bot-type" required>
                                <option value="discord">Discord</option>
                                <option value="telegram">Telegram</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="create-start-file" class="form-label">Стартовый файл</label>
                            <input type="text" class="form-control" id="create-start-file" placeholder="main.py">
                            <small class="form-text text-muted">Файл, который будет запускаться при старте бота</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-cpu-limit" class="form-label">Лимит CPU (%)</label>
                                    <input type="number" class="form-control" id="create-cpu-limit" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="create-memory-limit" class="form-label">Лимит памяти (MB)</label>
                                    <input type="number" class="form-control" id="create-memory-limit" min="64" value="512">
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <h6>GitHub репозиторий (опционально)</h6>
                        <div class="mb-3">
                            <label for="create-git-repo-url" class="form-label">URL репозитория</label>
                            <input type="text" class="form-control" id="create-git-repo-url" placeholder="https://github.com/user/repo.git">
                        </div>
                        
                        <div class="mb-3">
                            <label for="create-git-branch" class="form-label">Ветка</label>
                            <input type="text" class="form-control" id="create-git-branch" value="main" placeholder="main">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="createBot()">
                        <i class="fas fa-plus"></i> Создать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для подтверждения действий -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Подтверждение</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">Вы уверены?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Создание бота
        async function createBot() {
            const name = document.getElementById('create-bot-name').value;
            const botType = document.getElementById('create-bot-type').value;
            const startFile = document.getElementById('create-start-file').value;
            const cpuLimit = parseFloat(document.getElementById('create-cpu-limit').value) || 50;
            const memoryLimit = parseInt(document.getElementById('create-memory-limit').value) || 512;
            const gitRepoUrl = document.getElementById('create-git-repo-url').value.trim() || null;
            const gitBranch = document.getElementById('create-git-branch').value.trim() || 'main';
            
            if (!name.trim()) {
                showAlert('Пожалуйста, введите название бота', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name.trim(),
                        bot_type: botType,
                        start_file: startFile.trim() || null,
                        cpu_limit: cpuLimit,
                        memory_limit: memoryLimit,
                        git_repo_url: gitRepoUrl,
                        git_branch: gitBranch
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.id) {
                    // Закрываем модальное окно
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createBotModal'));
                    modal.hide();
                    
                    // Очищаем форму
                    document.getElementById('create-bot-form').reset();
                    
                    // Показываем сообщение
                    showAlert('Бот успешно создан!', 'success');
                    
                    // Переходим на страницу управления ботом
                    window.location.href = `/bot/${result.id}`;
                } else {
                    let errorMsg = result.detail || 'Неизвестная ошибка';
                    if (errorMsg.includes('already exists') || errorMsg.includes('уже существует')) {
                        errorMsg = 'Бот с таким именем уже существует. Выберите другое имя.';
                    }
                    showAlert('Ошибка создания бота: ' + errorMsg, 'danger');
                }
            } catch (error) {
                console.error('Error creating bot:', error);
                let errorMsg = 'Неизвестная ошибка';
                if (error.message && error.message.includes('fetch')) {
                    errorMsg = 'Не удалось подключиться к серверу. Проверьте соединение.';
                } else {
                    errorMsg = error.message || 'Произошла ошибка при создании бота';
                }
                showAlert('Ошибка создания бота: ' + errorMsg, 'danger');
            }
        }
    </script>
</body>
</html>
